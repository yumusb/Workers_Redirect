/*
* @Author: yumu
* @Date:   2020-03-26
* @Email:   yumusb@foxmail.com
* @Last Modified by:   yumu
* @Last Modified time: 2020-03-26
*/

addEventListener('fetch', event => {
    event.respondWith(fetchAndApply(event.request));
})
async function fetchAndApply(request) {
    let requestURL = new URL(request.url)
    let path = requestURL.pathname.slice(1)//获取访问的URL地址，取得的是第一个/之后的内容，如果访问 33.al/a 获取到a （默认忽略掉参数，也就是？之后的内容）
    var url = "https://raw.githubusercontent.com/yumusb/cdn/master/cloudflare/redirect.json" // 远程数据，存放JSON文件
    init = {
        method: "GET"
    };
    const response = await fetch(url, init);//请求上面给定的远程JSON
    var json = JSON.parse(await response.text());//解析JSON
    if (json.hasOwnProperty(path)) {
        url = json[path] //如果访问的URL有数据，就取这个URL的值
    } else {
        url = 'https://huai.pub' //如果没有给定的URL，就给出一个默认的。
    }
    //return Response.redirect(url, 301) //直接跳转，不返回页面。

    //给一个相对友好的加载页面
    someHTML = `<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><title>Loading...</title><meta http-equiv="refresh" content="3; url=` + url + `"><style>body{padding:0;margin:0;background-color:#f0f0f0;font-family:'Segoe UI'}.loader-wrapper{position:fixed;z-index:1090;height:100vh;width:100vw;background-color:rgba(240,240,240,.5)}.truck-wrapper{height:200px;width:200px;border:4px solid #1dd3d6;position:absolute;top:50%;left:50%;transform:translateX(-50%) translateY(-50%) scale(.8);background:#fff;animation:bg .5s linear infinite;border-radius:100%;overflow:hidden;box-shadow:inset 0 0 10px 4px rgba(0,0,0,.3),inset 0 0 5px 0 #1dd3d6}.truck-wrapper:after{content:'Loading';font-size:20px;position:absolute;bottom:0;text-align:center;width:100%;border-top:1px solid #1dd3d6;background:#1efcc8;background:-moz-linear-gradient(left,rgba(30,252,200,1) 0,rgba(29,211,214,1) 100%);background:-webkit-linear-gradient(left,rgba(30,252,200,1) 0,rgba(29,211,214,1) 100%);background:linear-gradient(to right,rgba(30,252,200,1) 0,rgba(29,211,214,1) 100%);color:#fff;padding-top:8px;padding-bottom:18px;animation:bg 3s linear infinite}.truck{height:110px;width:150px;position:absolute;bottom:48px;left:calc(50% + 10px);transform:translateX(-50%)}.truck>.truck-container{background:#afbdc3;background:-moz-linear-gradient(-45deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);background:-webkit-linear-gradient(-45deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);background:linear-gradient(135deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);height:50px;width:80px;position:absolute;top:10px;left:10px;animation:container .4s linear infinite}.truck>.glases{background:#28b5f5;background:-moz-linear-gradient(-45deg,rgba(40,181,245,1) 0,rgba(40,181,245,1) 50%,rgba(2,153,227,1) 52%,rgba(2,153,227,1) 100%);background:-webkit-linear-gradient(-45deg,rgba(40,181,245,1) 0,rgba(40,181,245,1) 50%,rgba(2,153,227,1) 52%,rgba(2,153,227,1) 100%);background:linear-gradient(135deg,rgba(40,181,245,1) 0,rgba(40,181,245,1) 50%,rgba(2,153,227,1) 52%,rgba(2,153,227,1) 100%);position:absolute;height:25px;width:25px;border:4px solid #fbd734;border-bottom:none;top:35px;left:95px;border-top-right-radius:6px;animation:updown-half .4s linear infinite}.truck>.glases:after{content:'';display:block;background-color:#fbd734;height:13px;width:10px;position:absolute;right:-10px;bottom:0;border-radius:10px/15px;border-bottom-right-radius:0;border-bottom-left-radius:0;border-top-left-radius:0}.truck>.glases:before{content:'';display:block;background-color:#f9bf2c;height:12px;width:16px;position:absolute;left:0;bottom:0;border-top-right-radius:4px}.truck>.bonet{background-color:#f9bf2c;position:absolute;width:124px;height:15px;top:64px;left:10px;z-index:-1;animation:updown .4s linear infinite}.truck>.bonet:after{content:'';display:block;background:#fff;background:-moz-linear-gradient(-45deg,rgba(255,255,255,1) 0,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);background:-webkit-linear-gradient(-45deg,rgba(255,255,255,1) 0,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);background:linear-gradient(135deg,rgba(255,255,255,1) 0,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);height:10px;width:6px;position:absolute;right:0;bottom:2px;border-top-left-radius:4px}.truck>.base{position:absolute;background-color:#445a64;width:106px;height:15px;border-top-right-radius:10px;top:70px;left:14px;animation:updown .4s linear infinite}.truck>.base:before{content:'';display:block;background-color:#e54a18;height:12px;width:5px;position:absolute;left:-4px;bottom:0;border-bottom-left-radius:4px}.truck>.base:after{content:'';display:block;background-color:RGB(84,110,122);height:10px;width:20px;position:absolute;right:-16px;bottom:0;border-bottom-right-radius:4px;z-index:-1}.truck>.base-aux{width:82px;height:8px;background-color:#f9bf2c;position:absolute;top:65px;left:14px;border-bottom-right-radius:4px;animation:updown .4s linear infinite}.truck>.wheel-back{left:20px}.truck>.wheel-front{left:95px}.truck>.wheel-back,.truck>.wheel-front{border-radius:100%;position:absolute;background:#546e7a;background:-moz-linear-gradient(-45deg,rgba(84,110,122,1) 0,rgba(84,110,122,1) 49%,rgba(68,90,100,1) 52%,rgba(68,90,100,1) 100%);background:-webkit-linear-gradient(-45deg,rgba(84,110,122,1) 0,rgba(84,110,122,1) 49%,rgba(68,90,100,1) 52%,rgba(68,90,100,1) 100%);background:linear-gradient(135deg,rgba(84,110,122,1) 0,rgba(84,110,122,1) 49%,rgba(68,90,100,1) 52%,rgba(68,90,100,1) 100%);top:80px;height:22px;width:22px;animation:spin .6s linear infinite}.truck>.wheel-back:before,.truck>.wheel-front:before{content:'';border-radius:100%;left:5px;top:5px;position:absolute;background:#afbdc3;background:-moz-linear-gradient(-45deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);background:-webkit-linear-gradient(-45deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);background:linear-gradient(135deg,rgba(175,189,195,1) 0,rgba(175,189,195,1) 50%,rgba(143,163,173,1) 51%,rgba(143,163,173,1) 100%);height:12px;width:12px}@keyframes spin{50%{top:81px}100%{transform:rotate(360deg)}}@keyframes container{30%{transform:rotate(1deg)}50%{top:11px}70%{top:10px;transform:rotate(-1deg)}}.truck>.smoke{position:absolute;background-color:#afbdc3;border-radius:100%;width:8px;height:8px;top:90px;left:6px;animation:fade .4s linear infinite;opacity:0}.truck>.smoke:after{content:'';position:absolute;background-color:RGB(143,163,173);border-radius:100%;width:6px;height:6px;top:-4px;left:4px}.truck>.smoke:before{content:'';position:absolute;background-color:RGB(143,163,173);border-radius:100%;width:4px;height:4px;top:-2px;left:0}@keyframes fade{30%{opacity:.3;left:7px}50%{opacity:.5;left:6px}70%{opacity:.1;left:4px}90%{opacity:.4;left:2px}}@keyframes bg{from{background-position-x:0}to{background-position-x:-400px}}@keyframes updown{50%{transform:translateY(-20%)}70%{transform:translateY(-10%)}}@keyframes updown-half{50%{transform:translateY(-10%)}70%{transform:translateY(-5%)}}</style></head><body><div class="loader-wrapper"><div class="truck-wrapper"><div class="truck"><div class="truck-container"></div><div class="glases"></div><div class="bonet"></div><div class="base"></div><div class="base-aux"></div><div class="wheel-back"></div><div class="wheel-front"></div><div class="smoke"></div></div></div></div></body></html>`
    init = {
        headers: {
            'content-type': 'text/html;charset=UTF-8',
            'X-Powered-By': '33.al',
        },
    }
    return new Response(someHTML, init)
    
}